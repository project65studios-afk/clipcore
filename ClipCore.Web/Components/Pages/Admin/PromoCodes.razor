@page "/admin/promo-codes"
@using ClipCore.Core.Entities
@using ClipCore.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject IPromoCodeRepository PromoCodeRepository
@inject IAuditService AuditService
@inject IJSRuntime JS
@rendermode RenderMode.InteractiveServer

<div class="admin-container" style="max-width: 1000px; margin: 2rem auto; padding: 0 1rem;">
    <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="font-size: 2rem; margin: 0;">Promo Codes</h1>
            <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0;">Manage discounts and offers.</p>
        </div>
        <div class="admin-actions" style="display: flex; gap: 1rem;">
            <a href="/admin" class="btn-secondary" style="text-decoration: none;">Back to Dashboard</a>
            <button class="btn-primary" @onclick="OpenCreateModal">+ New Promo Code</button>
        </div>
    </div>

    @if (_promoCodes == null)
    {
        <div style="display: flex; justify-content: center; padding: 4rem;">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (!_promoCodes.Any())
    {
        <div style="background: var(--bg-surface); padding: 4rem; text-align: center; border: 1px dashed var(--border-color); border-radius: var(--radius-lg);">
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">No promo codes found.</p>
            <button class="btn-secondary" @onclick="OpenCreateModal">Create your first code</button>
        </div>
    }
    else
    {
        <div style="background: var(--bg-surface); border-radius: var(--radius-lg); border: 1px solid var(--border-color); overflow: hidden;">
            <table class="responsive-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border-color);">
                        <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 500;">Code</th>
                        <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 500;">Discount</th>
                        <th style="padding: 1rem; text-align: center; color: var(--text-secondary); font-weight: 500;">Usage</th>
                        <th style="padding: 1rem; text-align: left; color: var(--text-secondary); font-weight: 500;">Expiry</th>
                        <th style="padding: 1rem; text-align: center; color: var(--text-secondary); font-weight: 500;">Status</th>
                        <th style="padding: 1rem; text-align: right; color: var(--text-secondary); font-weight: 500;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var promo in _promoCodes)
                    {
                        <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
                            <td style="padding: 1rem; font-weight: 700; color: var(--accent-primary); text-transform: uppercase;">@promo.Code</td>
                            <td style="padding: 1rem;">
                                @if (promo.DiscountType == DiscountType.Percentage)
                                {
                                    <span>@promo.Value% Off</span>
                                }
                                else
                                {
                                    <span>$@(promo.Value / 100.0) Off</span>
                                }
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                @promo.UsageCount / @(promo.MaxUsages?.ToString() ?? "âˆž")
                            </td>
                            <td style="padding: 1rem; color: var(--text-secondary);">
                                @(promo.ExpiryDate?.ToShortDateString() ?? "Never")
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                @if (promo.IsActive)
                                {
                                    @if (promo.ExpiryDate.HasValue && promo.ExpiryDate.Value < DateTime.UtcNow)
                                    {
                                        <span class="badge" style="background: var(--status-danger-dim); color: var(--status-danger); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Expired</span>
                                    }
                                    else if (promo.MaxUsages.HasValue && promo.UsageCount >= promo.MaxUsages.Value)
                                    {
                                        <span class="badge" style="background: var(--status-danger-dim); color: var(--status-danger); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Used Up</span>
                                    }
                                    else
                                    {
                                        <span class="badge" style="background: var(--status-success-dim); color: var(--status-success); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>
                                    }
                                }
                                else
                                {
                                    <span class="badge" style="background: rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Inactive</span>
                                }
                            </td>
                            <td style="padding: 1rem; text-align: right;">
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button class="btn-secondary btn-sm" style="font-size: 0.8rem; padding: 0.2rem 0.5rem;" @onclick="() => OpenEditModal(promo)">Edit</button>
                                    <button class="btn-secondary btn-sm" style="font-size: 0.8rem; padding: 0.2rem 0.5rem; border-color: var(--status-danger); color: var(--status-danger);" @onclick="() => ConfirmDelete(promo)">Delete</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (_isModalOpen && _editingPromo != null)
    {
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--bg-surface); padding: 2rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); max-width: 500px; width: 90%;">
                <h3 style="margin-bottom: 1.5rem;">@(_editingPromo.Id == 0 ? "Create Promo Code" : "Edit Promo Code")</h3>
                
                <div class="mb-3">
                    <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Code</label>
                    <input class="form-control" style="text-transform: uppercase;" @bind="_editingPromo.Code" placeholder="e.g. SUMMER20" />
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="mb-3">
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Type</label>
                        <select class="form-select @(true ? "bg-dark text-white border-secondary" : "")" @bind="_editingPromo.DiscountType">
                            <option value="@DiscountType.Percentage">Percentage %</option>
                            <option value="@DiscountType.FixedAmount">Fixed Amount $</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Value @(_editingPromo.DiscountType == DiscountType.Percentage ? "(%)" : "($)")</label>
                         @if (_editingPromo.DiscountType == DiscountType.Percentage)
                         {
                            <input class="form-control" type="number" @bind="_editingPromo.Value" />
                         }
                         else
                         {
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-white">$</span>
                                <input class="form-control" type="number" @onchange="@(e => _editingPromo.Value = (int)(float.Parse(e.Value?.ToString() ?? "0") * 100))" value="@(_editingPromo.Value / 100.0)" step="0.01" />
                            </div>
                         }
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="mb-3">
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Max Usages (Optional)</label>
                        <input class="form-control" type="number" @bind="_editingPromo.MaxUsages" placeholder="Unlimited" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="font-size: 0.85rem; color: var(--text-secondary);">Expiry Date (Optional)</label>
                        <input class="form-control" type="date" @bind="_editingPromo.ExpiryDate" />
                    </div>
                </div>

                <div class="mb-3 form-check" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" class="form-check-input" id="isActive" @bind="_editingPromo.IsActive" style="width: 1.2rem; height: 1.2rem; cursor: pointer;">
                    <label class="form-check-label" for="isActive" style="font-size: 0.9rem; cursor: pointer;">Is Active</label>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button class="btn-secondary" @onclick="CloseModal" disabled="@_isProcessing">Cancel</button>
                    <button class="btn-primary" @onclick="SavePromoAsync" disabled="@_isProcessing">
                        @(_isProcessing ? "Saving..." : "Save Code")
                    </button>
                </div>
            </div>
        </div>
    }

    @if (_isDeleting && _promoToDelete != null)
    {
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000;">
            <div style="background: var(--bg-surface); padding: 2rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color); max-width: 400px; width: 90%; text-align: center;">
                <h3 style="margin-bottom: 1rem;">Delete Promo Code?</h3>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Are you sure you want to delete <strong>@_promoToDelete.Code</strong>? This cannot be undone.</p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn-secondary" @onclick="() => _isDeleting = false">Cancel</button>
                    <button class="btn-primary" style="background: var(--status-danger); border-color: var(--status-danger);" @onclick="DeleteAsync">Yes, Delete</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<PromoCode>? _promoCodes;
    private bool _isModalOpen = false;
    private bool _isProcessing = false;
    private bool _isDeleting = false;
    private PromoCode? _editingPromo;
    private PromoCode? _promoToDelete;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await LoadPromoCodesAsync();
    }

    private async Task LoadPromoCodesAsync()
    {
        _promoCodes = await PromoCodeRepository.ListAsync();
    }

    private void OpenCreateModal()
    {
        _editingPromo = new PromoCode { IsActive = true };
        _isModalOpen = true;
    }

    private void OpenEditModal(PromoCode promo)
    {
        _editingPromo = new PromoCode
        {
            Id = promo.Id,
            Code = promo.Code,
            Value = promo.Value,
            DiscountType = promo.DiscountType,
            MaxUsages = promo.MaxUsages,
            UsageCount = promo.UsageCount,
            ExpiryDate = promo.ExpiryDate,
            IsActive = promo.IsActive,
            CreatedAt = promo.CreatedAt
        };
        _isModalOpen = true;
    }

    private void CloseModal()
    {
        _isModalOpen = false;
        _editingPromo = null;
    }

    private async Task SavePromoAsync()
    {
        if (_editingPromo == null || string.IsNullOrWhiteSpace(_editingPromo.Code)) return;

        Console.Out.WriteLine($"[PROMO-SAVE] Code: {_editingPromo.Code}, IsActive: {_editingPromo.IsActive}");

        _isProcessing = true;
        try
        {
             _editingPromo.Code = _editingPromo.Code.ToUpper().Trim();

            if (_editingPromo.ExpiryDate.HasValue)
            {
                // Ensure expiry is end of the selected day
                _editingPromo.ExpiryDate = _editingPromo.ExpiryDate.Value.Date.AddDays(1).AddSeconds(-1);
            }

            // Check if code exists (for new ones)
            if (_editingPromo.Id == 0)
            {
                var existing = await PromoCodeRepository.GetByCodeAsync(_editingPromo.Code);
                if (existing != null)
                {
                    await JS.InvokeVoidAsync("alert", "A promo code with this name already exists.");
                    return;
                }
                await PromoCodeRepository.AddAsync(_editingPromo);
            }
            else
            {
                await PromoCodeRepository.UpdateAsync(_editingPromo);
            }

            // Log action
            var authState = await AuthenticationStateTask;
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userEmail = user.Identity?.Name;

            await AuditService.LogActionAsync(
                userId, 
                userEmail, 
                _editingPromo.Id == 0 ? "Create Promo Code" : "Update Promo Code", 
                "PromoCode", 
                _editingPromo.Id.ToString(), 
                $"Code: {_editingPromo.Code}, Value: {_editingPromo.Value}, Type: {_editingPromo.DiscountType}");

            await LoadPromoCodesAsync();
            CloseModal();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void ConfirmDelete(PromoCode promo)
    {
        _promoToDelete = promo;
        _isDeleting = true;
    }

    private async Task DeleteAsync()
    {
        if (_promoToDelete == null) return;
        
        try
        {
            await PromoCodeRepository.DeleteAsync(_promoToDelete.Id);
            
            // Log action
            var authState = await AuthenticationStateTask;
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userEmail = user.Identity?.Name;

            await AuditService.LogActionAsync(
                userId, 
                userEmail, 
                "Delete Promo Code", 
                "PromoCode", 
                _promoToDelete.Id.ToString(), 
                $"Deleted code: {_promoToDelete.Code}");

            await LoadPromoCodesAsync();
            _isDeleting = false;
            _promoToDelete = null;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }
}
