@page "/admin/theme"
@rendermode RenderMode.InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using ClipCore.Core.Interfaces
@attribute [Authorize(Roles = "Admin")]
@inject ISettingsRepository SettingsRepository
@inject IAuditService AuditService
@inject IJSRuntime JS
@inject ClipCore.Web.Services.StoreSettingsService StoreSettingsService
@inject ClipCore.Web.Services.GlobalSettingsNotifier GlobalSettingsNotifier

<div class="admin-container" style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h1 class="fw-bold m-0" style="color: var(--text-main);">Theme & Appearance</h1>
            <p class="m-0 mt-1" style="color: var(--text-secondary);">Customize the visual identity of your storefront for both light and dark modes.</p>
        </div>
        <div class="d-flex gap-2">
             <a href="/admin/settings" class="btn btn-outline-secondary">
                <i class="bi bi-gear me-2"></i>General Settings
            </a>
            <a href="/admin" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Dashboard
            </a>
        </div>
    </div>

    <!-- Mode Selector Tabs -->
    <div class="card border-0 shadow-sm mb-4" style="background: var(--bg-surface); border: 1px solid var(--border-color) !important;">
        <div class="card-body p-2 d-flex gap-2">
            <button class="btn @(_activeTab == "dark" ? "btn-primary" : "btn-outline-secondary border-0") flex-grow-1" @onclick='() => _activeTab = "dark"'>
                <i class="bi bi-moon-stars me-2"></i>Dark Mode Appearance
            </button>
            <button class="btn @(_activeTab == "light" ? "btn-primary" : "btn-outline-secondary border-0") flex-grow-1" @onclick='() => _activeTab = "light"'>
                <i class="bi bi-sun me-2"></i>Light Mode Appearance
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- Sidebar: Controls -->
        <div class="col-lg-5">
            <div class="card shadow-sm h-100" style="background: var(--bg-surface); border: 1px solid var(--border-color);">
                <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="mb-0" style="color: var(--text-main);">
                        <i class="bi @(_activeTab == "dark" ? "bi-moon" : "bi-sun") me-2 text-primary"></i>
                        @(_activeTab == "dark" ? "Dark Theme Variables" : "Light Theme Variables")
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ResetToDefaults">Reset to Default</button>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-column gap-4">
                        @if (_activeTab == "dark")
                        {
                            <ThemeColorPicker Label="Background (Main)" HelpText="The primary background color of the site." @bind-Value="_dark.Background" />
                            <ThemeColorPicker Label="Surface (Cards/Modals)" HelpText="Used for cards, modals, and elevated UI elements." @bind-Value="_dark.Surface" />
                            <ThemeColorPicker Label="Primary Accent" HelpText="Main brand color used for accents and active states." @bind-Value="_dark.Primary" />
                            <ThemeColorPicker Label="Secondary Accent" HelpText="Supporting accent color for subtle highlights." @bind-Value="_dark.Secondary" />
                            <ThemeColorPicker Label="Text Primary" HelpText="Standard color for main headings and body text." @bind-Value="_dark.Text" />
                            
                            <hr class="my-4" style="border-color: var(--border-color);" />
                            <h6 class="small text-uppercase fw-bold mb-3" style="color: var(--text-muted);">Button & Brand</h6>
                            <ThemeColorPicker Label="Main Button Gradient Start" HelpText="Starting color for the glossy brand and button gradient." @bind-Value="_dark.BtnStart" />
                            <ThemeColorPicker Label="Main Button Gradient End" HelpText="Ending color for the glossy brand and button gradient." @bind-Value="_dark.BtnEnd" />
                            <ThemeColorPicker Label="Brand Title (First Part)" HelpText="Base color for the storefront name in the navigation bar." @bind-Value="_dark.BrandText" />
                        }
                        else
                        {
                            <ThemeColorPicker Label="Background (Main)" HelpText="The primary background color of the site." @bind-Value="_light.Background" />
                            <ThemeColorPicker Label="Surface (Cards/Modals)" HelpText="Used for cards, modals, and elevated UI elements." @bind-Value="_light.Surface" />
                            <ThemeColorPicker Label="Primary Accent" HelpText="Main brand color used for accents and active states." @bind-Value="_light.Primary" />
                            <ThemeColorPicker Label="Secondary Accent" HelpText="Supporting accent color for subtle highlights." @bind-Value="_light.Secondary" />
                            <ThemeColorPicker Label="Text Primary" HelpText="Standard color for main headings and body text." @bind-Value="_light.Text" />
                            
                            <hr class="my-4" style="border-color: var(--border-color);" />
                            <h6 class="small text-uppercase fw-bold mb-3" style="color: var(--text-muted);">Button & Brand</h6>
                            <ThemeColorPicker Label="Main Button Gradient Start" HelpText="Starting color for the glossy brand and button gradient." @bind-Value="_light.BtnStart" />
                            <ThemeColorPicker Label="Main Button Gradient End" HelpText="Ending color for the glossy brand and button gradient." @bind-Value="_light.BtnEnd" />
                            <ThemeColorPicker Label="Brand Title (First Part)" HelpText="Base color for the storefront name in the navigation bar." @bind-Value="_light.BrandText" />
                        }
                    </div>
                </div>
                <div class="card-footer bg-transparent p-4" style="border-top: 1px solid var(--border-color);">
                    <div class="d-flex justify-content-between align-items-center">
                         @if (_showSuccess)
                        {
                            <span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Theme updated!</span>
                        }
                        else
                        {
                            <span class="text-muted small">Changes apply globally upon saving.</span>
                        }
                        <button class="btn btn-primary px-4 py-2" @onclick="SaveTheme" disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span><span>Saving...</span>
                            }
                            else
                            {
                                <span><i class="bi bi-cloud-arrow-up me-2"></i>Save Appearance</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Area: Preview -->
        <div class="col-lg-7">
            <div class="card shadow-sm h-100 border-0" style="background: var(--bg-surface); border: 1px solid var(--border-color) !important;">
                <div class="card-header bg-transparent py-3" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="mb-0" style="color: var(--text-main);"><i class="bi bi-eyedropper me-2 text-info"></i>Live Preview</h5>
                </div>
                <div class="card-body p-0 overflow-hidden d-flex align-items-center justify-content-center" style="background: #000; min-height: 500px;">
                    <!-- The Preview Window -->
                    <div class="preview-window w-100 h-100" style="background: @(ActiveTheme.Background); color: @(ActiveTheme.Text); transition: all 0.3s ease; --bg-main: @(ActiveTheme.Background); --bg-surface: @(ActiveTheme.Surface); --accent-primary: @(ActiveTheme.Primary); --accent-secondary: @(ActiveTheme.Secondary); --text-main: @(ActiveTheme.Text); --btn-gradient-start: @(ActiveTheme.BtnStart); --btn-gradient-end: @(ActiveTheme.BtnEnd); --brand-text-main: @(ActiveTheme.BrandText); --accent-primary-gradient: linear-gradient(90deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);">
                        <div class="preview-nav p-3 d-flex justify-content-between align-items-center border-bottom" style="border-color: color-mix(in srgb, var(--text-main), transparent 90%) !important;">
                             <div class="fw-bold" style="letter-spacing: 1px;"><span class="brand-accent">PROJECT</span><span style="color: var(--brand-text-main); opacity: 0.9;">65</span></div>
                             <div class="d-flex gap-3 small opacity-75">
                                <span>Events</span><span>Search</span><span>Cart</span>
                             </div>
                        </div>
                        <div class="p-4">
                            <h4 class="mb-3" style="color: var(--text-main);">Live Preview</h4>
                            <div class="preview-card p-3 mb-3" style="background: var(--bg-surface); border: 1px solid color-mix(in srgb, var(--text-main), transparent 90%); border-radius: 8px;">
                                <div class="small opacity-75 mb-2" style="color: var(--text-main);">This card shows individual settings.</div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm" style="background: var(--accent-primary-gradient); color: #fff; border: none;">Primary Button</button>
                                    <button class="btn btn-sm" style="background: var(--accent-secondary); color: #fff; border: none; opacity: 0.8;">Secondary</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 p-3 rounded" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-info-circle" style="color: @(ActiveTheme.Primary);"></i>
                    <span class="small opacity-75">This is a simulation of the actual UI elements.</span>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string _activeTab = "dark";
    private ThemeConfig _dark = new();
    private ThemeConfig _light = new();
    private bool _isSaving;
    private bool _showSuccess;

    private ThemeConfig ActiveTheme => _activeTab == "dark" ? _dark : _light;

    protected override async Task OnInitializedAsync()
    {
        await LoadThemeSettings();
    }

    private async Task LoadThemeSettings()
    {
        // Dark Mode
        _dark.Primary = await SettingsRepository.GetValueAsync("ThemeDarkPrimary") ?? "#06b6d4";
        _dark.Secondary = await SettingsRepository.GetValueAsync("ThemeDarkSecondary") ?? "#ec4899";
        _dark.Background = await SettingsRepository.GetValueAsync("ThemeDarkBackground") ?? "#0f1129";
        _dark.Surface = await SettingsRepository.GetValueAsync("ThemeDarkSurface") ?? "#171936";
        _dark.Text = await SettingsRepository.GetValueAsync("ThemeDarkText") ?? "#ffffff";
        _dark.BtnStart = await SettingsRepository.GetValueAsync("ThemeDarkBtnStart") ?? "#0284c7";
        _dark.BtnEnd = await SettingsRepository.GetValueAsync("ThemeDarkBtnEnd") ?? "#06b6d4";
        _dark.BrandText = await SettingsRepository.GetValueAsync("ThemeDarkBrandText") ?? "#ffffff";

        // Light Mode
        _light.Primary = await SettingsRepository.GetValueAsync("ThemeLightPrimary") ?? "#06b6d4";
        _light.Secondary = await SettingsRepository.GetValueAsync("ThemeLightSecondary") ?? "#ec4899";
        _light.Background = await SettingsRepository.GetValueAsync("ThemeLightBackground") ?? "#f8fafc";
        _light.Surface = await SettingsRepository.GetValueAsync("ThemeLightSurface") ?? "#ffffff";
        _light.Text = await SettingsRepository.GetValueAsync("ThemeLightText") ?? "#0f172a";
        _light.BtnStart = await SettingsRepository.GetValueAsync("ThemeLightBtnStart") ?? "#0284c7";
        _light.BtnEnd = await SettingsRepository.GetValueAsync("ThemeLightBtnEnd") ?? "#06b6d4";
        _light.BrandText = await SettingsRepository.GetValueAsync("ThemeLightBrandText") ?? "#0f172a";
    }

    private void ResetToDefaults()
    {
        if (_activeTab == "dark")
        {
            _dark.Primary = "#06b6d4";
            _dark.Secondary = "#ec4899";
            _dark.Background = "#0f1129";
            _dark.Surface = "#171936";
            _dark.Text = "#ffffff";
            _dark.BtnStart = "#0284c7";
            _dark.BtnEnd = "#06b6d4";
            _dark.BrandText = "#ffffff";
        }
        else
        {
            _light.Primary = "#06b6d4";
            _light.Secondary = "#ec4899";
            _light.Background = "#f8fafc";
            _light.Surface = "#ffffff";
            _light.Text = "#0f172a";
            _light.BtnStart = "#0284c7";
            _light.BtnEnd = "#06b6d4";
            _light.BrandText = "#0f172a";
        }
    }

    private async Task SaveTheme()
    {
        _isSaving = true;
        _showSuccess = false;

        try
        {
            // Save Dark Settings
            await SettingsRepository.SetValueAsync("ThemeDarkPrimary", _dark.Primary);
            await SettingsRepository.SetValueAsync("ThemeDarkSecondary", _dark.Secondary);
            await SettingsRepository.SetValueAsync("ThemeDarkBackground", _dark.Background);
            await SettingsRepository.SetValueAsync("ThemeDarkSurface", _dark.Surface);
            await SettingsRepository.SetValueAsync("ThemeDarkText", _dark.Text);
            await SettingsRepository.SetValueAsync("ThemeDarkBtnStart", _dark.BtnStart);
            await SettingsRepository.SetValueAsync("ThemeDarkBtnEnd", _dark.BtnEnd);
            await SettingsRepository.SetValueAsync("ThemeDarkBrandText", _dark.BrandText);

            // Save Light Settings
            await SettingsRepository.SetValueAsync("ThemeLightPrimary", _light.Primary);
            await SettingsRepository.SetValueAsync("ThemeLightSecondary", _light.Secondary);
            await SettingsRepository.SetValueAsync("ThemeLightBackground", _light.Background);
            await SettingsRepository.SetValueAsync("ThemeLightSurface", _light.Surface);
            await SettingsRepository.SetValueAsync("ThemeLightText", _light.Text);
            await SettingsRepository.SetValueAsync("ThemeLightBtnStart", _light.BtnStart);
            await SettingsRepository.SetValueAsync("ThemeLightBtnEnd", _light.BtnEnd);
            await SettingsRepository.SetValueAsync("ThemeLightBrandText", _light.BrandText);

            // Notify all theme changes globally so DynamicTheme reloads
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkPrimary", _dark.Primary);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkSecondary", _dark.Secondary);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkBackground", _dark.Background);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkSurface", _dark.Surface);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkText", _dark.Text);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkBtnStart", _dark.BtnStart);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkBtnEnd", _dark.BtnEnd);
            GlobalSettingsNotifier.NotifyUpdate("ThemeDarkBrandText", _dark.BrandText);
            
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightPrimary", _light.Primary);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightSecondary", _light.Secondary);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightBackground", _light.Background);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightSurface", _light.Surface);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightText", _light.Text);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightBtnStart", _light.BtnStart);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightBtnEnd", _light.BtnEnd);
            GlobalSettingsNotifier.NotifyUpdate("ThemeLightBrandText", _light.BrandText);

            // Log
            await AuditService.LogActionAsync(null, "Admin", "Update Theme", "Settings", "Theme", "Theme colors updated for both modes.");

            _showSuccess = true;
            _ = Task.Delay(3000).ContinueWith(_ => { _showSuccess = false; InvokeAsync(StateHasChanged); });
        }
        finally
        {
            _isSaving = false;
        }
    }

    private class ThemeConfig
    {
        public string Primary { get; set; } = "#06b6d4";
        public string Secondary { get; set; } = "#ec4899";
        public string Background { get; set; } = "#0f1129";
        public string Surface { get; set; } = "#171936";
        public string Text { get; set; } = "#ffffff";
        public string BtnStart { get; set; } = "#0284c7";
        public string BtnEnd { get; set; } = "#06b6d4";
        public string BrandText { get; set; } = "#ffffff";
    }
}
