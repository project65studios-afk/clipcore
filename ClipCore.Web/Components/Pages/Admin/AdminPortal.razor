@page "/admin"
@using ClipCore.Core.Entities
@using ClipCore.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = "TenantAdmin")]
@inject IEventRepository EventRepository
@inject IExternalProductRepository ProductRepository
@inject IVideoService VideoService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IStorageService StorageService
@inject IAuditService AuditService
@rendermode RenderMode.InteractiveServer

<div class="container-fluid py-4" style="max-width: 1400px;">
    <!-- Header & Toolbar -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1 text-body">Admin Portal</h1>
            <p class="text-body opacity-75 mb-0">Manage system, commerce, and logs.</p>
        </div>
        
        <div class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center gap-2 w-100 w-md-auto">
            <div class="position-relative flex-grow-1" style="min-width: 200px;">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" class="form-control ps-5" placeholder="Search..." @bind="SearchTerm" @bind:event="oninput" />
            </div>
             <a href="/admin/upload" class="btn btn-primary d-flex align-items-center justify-content-center gap-2 fw-bold shadow-sm">
                <i class="bi bi-cloud-upload"></i> <span>New Event</span>
            </a>
        </div>
    </div>

    <!-- Quick Access Navigation -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-2 d-flex flex-wrap gap-2 align-items-center">
            <span class="text-body opacity-75 small fw-bold text-uppercase ms-2 me-2">Commerce</span>
            <div class="btn-group" role="group">
                <a href="/admin/products" class="btn btn-outline-secondary border-0 btn-sm d-flex align-items-center gap-2 text-body">
                    <i class="bi bi-bag"></i> Products
                </a>
                <a href="/admin/sales" class="btn btn-outline-secondary border-0 btn-sm d-flex align-items-center gap-2 text-body">
                    <i class="bi bi-currency-dollar"></i> Sales
                </a>
                 <a href="/admin/promo-codes" class="btn btn-outline-secondary border-0 btn-sm d-flex align-items-center gap-2 text-body">
                    <i class="bi bi-ticket-perforated"></i> Promo Codes
                </a>
            </div>
            
            <div class="vr mx-2 bg-secondary opacity-25"></div>
            
            <span class="text-body opacity-75 small fw-bold text-uppercase me-2">System</span>
             <div class="btn-group" role="group">
                <a href="/admin/audit-logs" class="btn btn-outline-secondary border-0 btn-sm d-flex align-items-center gap-2 text-body">
                    <i class="bi bi-journal-text"></i> Audit Logs
                </a>
                <a href="/admin/theme" class="btn btn-outline-secondary border-0 btn-sm d-flex align-items-center gap-2 text-body">
                    <i class="bi bi-palette"></i> Theme
                </a>
                <a href="/admin/settings" class="btn btn-outline-secondary border-0 btn-sm d-flex align-items-center gap-2 text-body">
                    <i class="bi bi-gear"></i> Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Events Table -->
    @if (_events == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-3">Loading events...</p>
        </div>
    }
    else if (!FilteredEvents.Any())
    {
        <div class="text-center py-5 card border-0 shadow-sm">
            <div class="card-body">
                <i class="bi bi-filter display-4 text-muted mb-3 d-block"></i>
                <h3 class="h5 text-body">No events found</h3>
                <p class="text-secondary mb-0">Try adjusting your search filters.</p>
            </div>
        </div>
    }
    else
    {
        <div class="card border-0 shadow-sm overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 text-uppercase text-body small fw-bold" style="width: 15%;">Date</th>
                            <th class="text-uppercase text-body small fw-bold" style="width: 30%;">Event Name</th>
                            <th class="text-uppercase text-body small fw-bold d-none d-md-table-cell" style="width: 20%;">Location</th>
                            <th class="text-uppercase text-body small fw-bold d-none d-md-table-cell" style="width: 20%;">Stats</th>
                            <th class="text-end pe-4 text-uppercase text-body small fw-bold" style="width: 15%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var evt in FilteredEvents)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold text-body">@evt.Date.ToString("MMM dd, yyyy")</span>
                                        <span class="small text-secondary">@evt.Date.ToString("dddd")</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-bold text-body text-truncate" style="max-width: 300px;" title="@evt.Name">@evt.Name</div>
                                    <div class="small text-secondary text-truncate" style="max-width: 300px;">ID: @evt.Id</div>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    @if (!string.IsNullOrEmpty(evt.Location))
                                    {
                                        <span class="text-secondary"><i class="bi bi-geo-alt me-1"></i>@evt.Location</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted opacity-50 fst-italic">No location</span>
                                    }
                                </td>
                                <td class="d-none d-md-table-cell">
                                    <div class="d-flex gap-3">
                                        <div class="d-flex align-items-center gap-1" title="Video Clips">
                                            <i class="bi bi-film text-secondary"></i>
                                            <span class="fw-bold text-body">@evt.Clips.Count</span>
                                        </div>
                                        @if (evt.FeaturedProducts.Any())
                                        {
                                            <div class="d-flex align-items-center gap-1" title="Featured Products">
                                                <i class="bi bi-bag-check-fill text-primary"></i>
                                                <span class="fw-bold text-body">@evt.FeaturedProducts.Count</span>
                                            </div>
                                        }
                                    </div>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="d-flex justify-content-end gap-2">
                                        <a href="/events/@evt.Id" class="btn btn-sm btn-outline-secondary border-0" title="View Public Page">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-primary border-0 fw-bold" @onclick="() => OpenEditModal(evt)">
                                            Edit
                                        </button>

                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@if (_isEditing && _eventToEdit != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title fw-bold">Edit Event</h5>
                        <div class="text-muted small">ID: @_eventToEdit.Id</div>
                    </div>
                    <button type="button" class="btn-close" @onclick="CancelEdit"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="row g-0">
                        <!-- Left Column: Event Details -->
                        <div class="col-lg-7 p-4 border-end">
                            <h6 class="text-uppercase text-secondary fw-bold small mb-4">Event Details</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Event Name</label>
                                <input class="form-control" @bind="_eventToEdit.Name" />
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date</label>
                                    <input class="form-control" type="date" @bind="_eventToEdit.Date" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Location</label>
                                    <input class="form-control" placeholder="e.g. Los Angeles, CA" @bind="_eventToEdit.Location" />
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Summary</label>
                                <textarea class="form-control" rows="5" @bind="_eventToEdit.Summary" placeholder="Describe the event..."></textarea>
                            </div>
                        </div>

                        <!-- Right Column: Featured Products -->
                        <div class="col-lg-5 p-4 bg-light bg-opacity-10">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="text-uppercase text-primary fw-bold small mb-0"><i class="bi bi-star me-2"></i>Featured Products</h6>
                                <a href="/admin/products" class="btn btn-sm btn-outline-primary" target="_blank" style="font-size: 0.75rem;">Manage Inventory <i class="bi bi-box-arrow-up-right ms-1"></i></a>
                            </div>

                            @if (_allProducts == null || !_allProducts.Any())
                            {
                                <div class="text-center py-5 border border-dashed rounded">
                                    <i class="bi bi-bag-x text-muted display-6 mb-2"></i>
                                    <p class="text-muted small">No products available.</p>
                                </div>
                            }
                            else
                            {
                                <div class="product-selection-list pe-2" style="max-height: 250px; overflow-y: auto;">
                                    @foreach (var prod in _allProducts)
                                    {
                                        var isSelected = IsProductSelected(prod.Id);
                                        <div class="d-flex align-items-center border rounded p-2 mb-2 product-select-item @(isSelected ? "border-primary bg-primary bg-opacity-10" : "bg-body")" 
                                             style="cursor: pointer; transition: all 0.2s;"
                                             @onclick="() => ToggleProductSelection(prod.Id, !isSelected)">
                                            
                                            <div class="form-check m-0 me-3">
                                                <input class="form-check-input" type="checkbox" checked="@isSelected" readonly style="pointer-events: none;">
                                            </div>
                                            
                                            <div class="rounded border me-3 d-flex align-items-center justify-content-center overflow-hidden bg-white" style="width: 48px; height: 48px;">
                                                @if (!string.IsNullOrEmpty(prod.ImageUrl))
                                                {
                                                     <img src="@GetThumbnailUrl(prod.ImageUrl)" style="width: 100%; height: 100%; object-fit: cover;" />
                                                }
                                                else
                                                {
                                                    <i class="bi bi-image text-muted"></i>
                                                }
                                            </div>
                                            
                                            <div class="flex-grow-1">
                                                <div class="fw-bold small text-body">@prod.Title</div>
                                                <div class="text-muted small">@prod.PriceDisplay</div>
                                            </div>
                                            
                                            @if (prod.IsSoldOut)
                                            {
                                                <span class="badge bg-danger text-uppercase" style="font-size: 0.6rem;">Sold Out</span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Bottom Section: Clip Prices -->
                    <div class="p-4 border-top">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                             <h6 class="text-uppercase text-secondary fw-bold small mb-0">Clip Prices</h6>
                             <div class="text-muted small"><i class="bi bi-star-fill text-warning me-1"></i> Star a clip to use it as the event thumbnail.</div>
                        </div>
                        
                        @if (_eventToEdit.Clips == null || !_eventToEdit.Clips.Any())
                        {
                            <div class="text-center py-4 border border-dashed rounded">
                                <p class="text-muted mb-0">No clips found for this event.</p>
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive rounded border" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm align-middle mb-0">
                                    <thead class="bg-light sticky-top">
                                        <tr>
                                            <th class="ps-3 py-2" style="width: 40%;">Clip Title</th>
                                            <th class="py-2 text-center" style="width: 10%;">Hero</th>
                                            <th class="py-2" style="width: 25%;">Personal Price ($)</th>
                                            <th class="py-2" style="width: 25%;">Commercial Price ($)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var clip in _eventToEdit.Clips)
                                        {
                                            <tr>
                                                <td class="ps-3 fw-bold small">@clip.Title</td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm border-0 p-0 fs-5" @onclick="() => ToggleHeroClip(clip.Id)" title="Set as Event Thumbnail">
                                                        @if (_eventToEdit.HeroClipId == clip.Id)
                                                        {
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-star text-muted opacity-25"></i>
                                                        }
                                                    </button>
                                                </td>
                                                <td>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" 
                                                               value="@(clip.PriceCents / 100.0)" 
                                                               @onchange="@(e => { if (double.TryParse(e.Value?.ToString(), out var val)) clip.PriceCents = (int)(val * 100); })" 
                                                               step="0.01" />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" 
                                                               value="@(clip.PriceCommercialCents / 100.0)" 
                                                               @onchange="@(e => { if (double.TryParse(e.Value?.ToString(), out var val)) clip.PriceCommercialCents = (int)(val * 100); })" 
                                                               step="0.01" />
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <div>
                         <button class="btn btn-outline-danger px-3" @onclick="() => InitiateDeleteFromEdit(_eventToEdit)">
                            <i class="bi bi-trash me-2"></i>Delete Event
                         </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" @onclick="CancelEdit" disabled="@_isProcessing">Cancel</button>
                        <button class="btn btn-primary px-4" @onclick="SaveEditAsync" disabled="@_isProcessing">
                            @(_isProcessing ? "Saving..." : "Save Changes")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (_isDeleting)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header border-danger">
                    <h5 class="modal-title text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Event?</h5>
                    <button type="button" class="btn-close" @onclick="() => _isDeleting = false"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <p class="text-body lead mb-1">Are you sure you want to delete <strong>@_eventToDelete?.Name</strong>?</p>
                    <p class="text-muted small">This will permanently remove <strong>@_eventToDelete?.Clips.Count</strong> videos from Mux/Storage. This action cannot be undone.</p>
                </div>
                <div class="modal-footer justify-content-center border-0 pb-4">
                    <button class="btn btn-outline-secondary px-4" @onclick="() => _isDeleting = false" disabled="@_isProcessing">Cancel</button>
                    <button class="btn btn-danger px-4" @onclick="DeleteAsync" disabled="@_isProcessing">
                        @(_isProcessing ? "Deleting..." : "Yes, Delete Everything")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .product-select-item:hover {
        background-color: var(--bg-light) !important;
    }
    /* Minimal table overrides for dark mode feel inside standard structure */
    .table-hover tbody tr:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.05) !important;
    }
</style>

@code {
    private List<Event>? _events;
    public string SearchTerm { get; set; } = "";
    private List<ExternalProduct> _allProducts = new();
    private bool _isDeleting = false;
    private bool _isEditing = false;
    private bool _isProcessing = false;
    private Event? _eventToDelete;
    private Event? _eventToEdit;
    
    // Temporary list to track selections during edit
    private List<string> _selectedProductIds = new();
    
    private IEnumerable<Event> FilteredEvents =>
        string.IsNullOrWhiteSpace(SearchTerm) 
            ? _events ?? Enumerable.Empty<Event>()
            : _events?.Where(e => e.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || 
                                  (e.Location?.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) 
                    ?? Enumerable.Empty<Event>();

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await LoadEventsAsync();
        _allProducts = await ProductRepository.GetAllAsync();
    }

    private async Task LoadEventsAsync()
    {
        _events = (await EventRepository.ListAsync()).OrderByDescending(e => e.Date).ToList();
    }

    private void OpenEditModal(Event evt)
    {
        // Clone to avoid editing the list item directly before saving
        _eventToEdit = new Event
        {
            Id = evt.Id,
            Name = evt.Name,
            Date = evt.Date,
            Location = evt.Location,
            Summary = evt.Summary,
            CreatedAt = evt.CreatedAt,
            HeroClipId = evt.HeroClipId,
            // Deep clone clips so we can cancel changes
            Clips = evt.Clips.Select(c => new Clip
            {
                Id = c.Id,
                Title = c.Title,
                PriceCents = c.PriceCents,
                PriceCommercialCents = c.PriceCommercialCents,
                EventId = c.EventId,
                MuxAssetId = c.MuxAssetId,
                MuxUploadId = c.MuxUploadId,
                PlaybackIdTeaser = c.PlaybackIdTeaser,
                PlaybackIdSigned = c.PlaybackIdSigned,
                ThumbnailFileName = c.ThumbnailFileName,
                MasterFileName = c.MasterFileName,
                DurationSec = c.DurationSec,
                Width = c.Width,
                Height = c.Height,
                TagsJson = c.TagsJson,
                PublishedAt = c.PublishedAt,
                RecordingStartedAt = c.RecordingStartedAt
            }).ToList(), 
            FeaturedProducts = new List<ExternalProduct>(evt.FeaturedProducts) // Shallow copy list
        };
        
        _selectedProductIds = _eventToEdit.FeaturedProducts.Select(p => p.Id).ToList();
        _isEditing = true;
    }
    
    private bool IsProductSelected(string productId)
    {
        return _selectedProductIds.Contains(productId);
    }
    
    private void ToggleProductSelection(string productId, bool isChecked)
    {
        if (isChecked && !_selectedProductIds.Contains(productId))
        {
            _selectedProductIds.Add(productId);
        }
        else if (!isChecked && _selectedProductIds.Contains(productId))
        {
            _selectedProductIds.Remove(productId);
        }
    }

    private void CancelEdit()
    {
        _isEditing = false;
        _eventToEdit = null;
    }

    private async Task SaveEditAsync()
    {
        if (_eventToEdit == null) return;

        _isProcessing = true;
        try
        {
            // Reconstruct the FeaturedProducts list based on IDs
            _eventToEdit.FeaturedProducts = _allProducts
                .Where(p => _selectedProductIds.Contains(p.Id))
                .ToList();
            
            await EventRepository.UpdateAsync(_eventToEdit);
            
             // Log the action
            var authState = await AuthenticationStateTask;
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userEmail = user.Identity?.Name;

            await AuditService.LogActionAsync(
                userId, 
                userEmail, 
                "Update Event", 
                "Event", 
                _eventToEdit.Id, 
                $"Event updated: {_eventToEdit.Name}");


            await LoadEventsAsync();
            _isEditing = false;
            _eventToEdit = null;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error saving event: {ex.Message}");
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private void InitiateDeleteFromEdit(Event evt)
    {
        // Close the edit modal
        _isEditing = false;
        
        // Open the delete confirmation modal
        // We need to find the original event object from the list to pass to ConfirmDelete
        // because ConfirmDelete expects an object that might be used for display or reference.
        // However, since we have the ID, we can just use the cloned one or look up.
        // Simpler: Just pass the cloned one, as ConfirmDelete mainly needs the ID and Name for display.
        
        ConfirmDelete(evt);
    }

    private void ConfirmDelete(Event evt)
    {
        _eventToDelete = evt;
        _isDeleting = true;
    }

    private async Task DeleteAsync()
    {
        if (_eventToDelete == null) return;
        
        _isProcessing = true;
        try 
        {
            // 1. Delete Mux Assets
            foreach (var clip in _eventToDelete.Clips)
            {
                var assetId = clip.MuxAssetId;
                
                // If AssetId is missing but we have UploadId, try to resolve it
                if (string.IsNullOrEmpty(assetId) && !string.IsNullOrEmpty(clip.MuxUploadId))
                {
                    assetId = await VideoService.GetAssetIdFromUploadAsync(clip.MuxUploadId);
                }

                if (!string.IsNullOrEmpty(assetId))
                {
                    await VideoService.DeleteAssetAsync(assetId);
                }

                // 2. Delete Thumbnail from Storage
                if (!string.IsNullOrEmpty(clip.ThumbnailFileName) && !clip.ThumbnailFileName.StartsWith("http"))
                {
                    var storageKey = clip.ThumbnailFileName.Contains("/") 
                        ? clip.ThumbnailFileName 
                        : $"thumbnails/{clip.ThumbnailFileName}";
                    await StorageService.DeleteAsync(storageKey);
                }
            }

            // 3. Delete from DB
            await EventRepository.DeleteAsync(_eventToDelete.Id);
            
             // Log the action
            var authState = await AuthenticationStateTask;
            var user = authState.User;
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var userEmail = user.Identity?.Name;

            await AuditService.LogActionAsync(
                userId, 
                userEmail, 
                "Delete Event", 
                "Event", 
                _eventToDelete.Id, 
                $"Event deleted: {_eventToDelete.Name} with {_eventToDelete.Clips.Count} clips");


            // 3. Refresh
            await LoadEventsAsync();
            _isDeleting = false;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error during deletion: {ex.Message}");
        }
        finally
        {
            _isProcessing = false;
            _eventToDelete = null;
        }
    }

    private void ToggleHeroClip(string clipId)
    {
        if (_eventToEdit == null) return;

        if (_eventToEdit.HeroClipId == clipId)
        {
            // Toggle off if already selected (optional, but good UX)
            _eventToEdit.HeroClipId = null;
        }
        else
        {
            _eventToEdit.HeroClipId = clipId;
        }
    }
    
    private string GetThumbnailUrl(string urlOrKey)
    {
        if (string.IsNullOrEmpty(urlOrKey)) return "";
        if (urlOrKey.StartsWith("http")) return urlOrKey;
        // Use presigned url for images
        return StorageService.GetPresignedDownloadUrl(urlOrKey);
    }
}
