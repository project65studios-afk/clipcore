@page "/admin/fulfillment"
@using ClipCore.Core.Entities
@using ClipCore.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject IPurchaseRepository PurchaseRepository
@inject IClipRepository ClipRepository
@inject NavigationManager Navigation
@inject IVideoService VideoService
@inject IJSRuntime JSRuntime
@inject IStorageService StorageService
@inject IEmailService EmailService
@inject IAuditService AuditService
@inject ClipCore.Web.Services.EmailTemplateService EmailTemplateService
@rendermode RenderMode.InteractiveServer

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0"><i class="bi bi-magic me-2"></i>Order Fulfillment</h2>
        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadDataAsync">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm" style="background: var(--bg-surface);">
        <div class="card-header bg-transparent border-bottom py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">Delivery Queue</h5>
            <div class="btn-group shadow-sm">
                <button class="btn btn-sm @(_currentFilter == "Pending" ? "btn-warning text-white" : "btn-outline-secondary border-secondary-subtle")" 
                        @onclick='() => SetFilter("Pending")'>Pending</button>
                <button class="btn btn-sm @(_currentFilter == "Fulfilled" ? "btn-success" : "btn-outline-secondary border-secondary-subtle")" 
                        @onclick='() => SetFilter("Fulfilled")'>Fulfilled</button>
                <button class="btn btn-sm @(_currentFilter == "All" ? "btn-dark" : "btn-outline-secondary border-secondary-subtle")" 
                        @onclick='() => SetFilter("All")'>All</button>
            </div>
        </div>
        <div class="card-body p-0 bg-transparent">
                @if (_filteredPurchases == null)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                }
                else if (!_filteredPurchases.Any())
                {
                    <div class="text-center py-5 text-muted">No orders found matching this filter.</div>
                }
                else
                {
                    var groupedOrders = _filteredPurchases
                        .GroupBy(p => p.StripeSessionId)
                        .OrderByDescending(g => g.First().CreatedAt)
                        .ToList();

                    foreach (var order in groupedOrders)
                    {
                        var firstItem = order.First();
                        var orderId = !string.IsNullOrEmpty(firstItem.StripeSessionId) && firstItem.StripeSessionId.Length >= 8
                            ? "ORD-" + firstItem.StripeSessionId.Substring(firstItem.StripeSessionId.Length - 8).ToUpper() 
                            : "LEGACY-" + firstItem.Id;

                        <div class="card border-0 shadow-sm mb-4 mx-3 mt-3 overflow-hidden rounded-3" style="background: var(--bg-subtle); border: 1px solid var(--border-color) !important;">
                             
                             <!-- Order Header -->
                             <div class="card-header bg-transparent p-3 border-bottom border-secondary-subtle">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="fw-bold fs-5 text-primary">@orderId</div>
                                            <span class="badge bg-dark text-secondary border border-secondary-subtle">@order.Count() Items</span>
                                        </div>
                                        <div class="text-muted small">
                                            @firstItem.CreatedAt.ToLocalTime().ToString("MMMM dd, yyyy") at @firstItem.CreatedAt.ToLocalTime().ToString("t")
                                        </div>
                                    </div>
                                    <div class="col-md-8 text-md-end mt-2 mt-md-0">
                                        <div class="d-flex justify-content-md-end gap-3 text-start text-md-end align-items-center">
                                            
                                            <!-- Order Completion Logic -->
                                            @{
                                                var allFilesUploaded = order.All(p => !string.IsNullOrEmpty(p.Clip?.MasterFileName) || !string.IsNullOrEmpty(p.ClipMasterFileName));
                                                var isFullyFulfilled = order.All(p => p.FulfillmentStatus == FulfillmentStatus.Fulfilled);
                                            }

                                            @if (isFullyFulfilled)
                                            {
                                                <!-- Ready / Copy Link -->
                                                <div class="d-flex align-items-center gap-2 bg-dark border border-secondary-subtle rounded px-2 py-1">
                                                    <button class="btn btn-outline-primary btn-sm me-2" @onclick="() => CompleteOrder(order.ToList(), true)" title="Resend Email">
                                                        <i class="bi bi-envelope-at me-1"></i> Resend Email
                                                    </button>
                                                    <span class="badge bg-success small text-uppercase">Ready</span>
                                                    <div class="input-group input-group-sm" style="width: 260px;">
                                                        <input type="text" class="form-control bg-dark border-secondary text-primary font-monospace" 
                                                               style="font-size: 0.8rem;"
                                                               readonly value="@($"{Navigation.BaseUri}delivery/{firstItem.StripeSessionId}")" 
                                                               onclick="this.select()" />
                                                        <button class="btn btn-outline-secondary" onclick="navigator.clipboard.writeText(this.previousElementSibling.value)" title="Copy Link">
                                                            <i class="bi bi-clipboard"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                            else if (allFilesUploaded)
                                            {
                                                <!-- Action Button -->
                                                <button class="btn btn-success btn-sm shadow-sm" @onclick="() => CompleteOrder(order.ToList())">
                                                    <i class="bi bi-send-check me-1"></i> Complete & Send Email
                                                </button>
                                            }
                                            else
                                            {
                                                <!-- Action Buttons -->
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-primary btn-sm shadow-sm" @onclick="() => OpenBulkUploadModal(order.ToList())">
                                                        <i class="bi bi-cloud-upload me-1"></i> Fulfill All
                                                    </button>
                                                </div>
                                            }

                                            <div class="vr mx-2 d-none d-md-block text-secondary"></div>

                                            <div class="d-flex gap-5 align-items-start text-start">
                                                <div style="min-width: 150px;">
                                                    <div class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 0.5px;">Customer</div>
                                                    <div class="fw-bold text-primary" style="line-height: 1.4;">@(firstItem.CustomerName ?? "Anonymous")</div>
                                                    <div class="small text-secondary" style="line-height: 1.4;">@(firstItem.CustomerEmail ?? "No Email")</div>
                                                    <div class="small text-secondary" style="line-height: 1.4;">
                                                        @if (!string.IsNullOrEmpty(firstItem.CustomerPhone))
                                                        {
                                                            <i class="bi bi-telephone me-1"></i>@firstItem.CustomerPhone
                                                        }
                                                        else
                                                        {
                                                            <span>&nbsp;</span>
                                                        }
                                                    </div>
                                                </div>
                                                @if (!string.IsNullOrEmpty(firstItem.CustomerAddress))
                                                {
                                                    <div style="min-width: 180px;">
                                                        <div class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 0.5px;">Billing Address</div>
                                                        @{
                                                            var parts = firstItem.CustomerAddress.Split(new[] { ", " }, StringSplitOptions.RemoveEmptyEntries);
                                                            if (parts.Length >= 3)
                                                            {
                                                                <div class="fw-bold text-primary" style="max-width: 250px; line-height: 1.4;">@parts[0]</div>
                                                                <div class="small text-secondary" style="max-width: 250px; line-height: 1.4;">@string.Join(", ", parts.Skip(1).Take(parts.Length - 2))</div>
                                                                
                                                                var country = parts.Last();
                                                                if (country.Trim().Equals("US", StringComparison.OrdinalIgnoreCase)) country = "USA";
                                                                
                                                                <div class="small text-secondary text-uppercase" style="max-width: 250px; line-height: 1.4;">@country</div>
                                                            }
                                                            else
                                                            {
                                                                <div class="fw-bold text-primary" style="max-width: 250px; line-height: 1.4;">@firstItem.CustomerAddress</div>
                                                                <div class="small text-secondary" style="line-height: 1.4;">&nbsp;</div>
                                                                <div class="small text-secondary" style="line-height: 1.4;">&nbsp;</div>
                                                            }
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                             </div>

                             <!-- Items Table -->
                             <div class="table-responsive bg-transparent">
                                <table class="table table-hover mb-0 align-middle mobile-card-view">
                                    <thead class="bg-black bg-opacity-25">
                                        <tr class="text-uppercase text-muted small border-bottom">
                                            <th class="ps-4 py-3" style="width: 35%;">Clip Info</th>
                                            <th style="width: 20%;">Event Details</th>
                                            <th style="width: 15%;">Price / Duration</th>
                                            <th style="width: 15%;">Status</th>
                                            <th class="text-end pe-4" style="width: 15%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var p in order)
                                        {
                                            <tr class="border-secondary-subtle">
                                                <td class="ps-4" data-label="Clip Info">
                                                    <div class="fw-bold text-primary">@(p.Clip?.Title ?? p.ClipTitle ?? "Deleted Clip")</div>
                                                    <div class="small text-muted font-monospace mt-1">
                                                        <i class="bi bi-file-earmark-film me-1"></i>
                                                        @(p.Clip?.MasterFileName ?? p.ClipMasterFileName ?? "No Master File")
                                                    </div>
                                                    <div class="mt-1">
                                                        <span class="badge" style="background: @(p.LicenseType == LicenseType.Commercial ? "var(--accent-purple-dim)" : "var(--accent-primary-dim)"); color: @(p.LicenseType == LicenseType.Commercial ? "var(--accent-purple)" : "var(--accent-primary)"); border: 1px solid currentColor; font-size: 0.65rem; text-transform: uppercase; font-weight: 600;">
                                                            @p.LicenseType
                                                        </span>
                                                    </div>
                                                    @{
                                                        var startTime = p.Clip?.RecordingStartedAt ?? p.ClipRecordingStartedAt;
                                                    }
                                                    @if (startTime.HasValue)
                                                    {
                                                        <div class="small text-secondary mt-1">
                                                            <i class="bi bi-clock me-1"></i> @startTime.Value.ToLocalTime().ToString("h:mm tt")
                                                        </div>
                                                    }
                                                </td>
                                                <td data-label="Event Details">
                                                    @if (!string.IsNullOrEmpty(p.EventName))
                                                    {
                                                        <div class="text-primary">@p.EventName</div>
                                                        @if (p.EventDate.HasValue)
                                                        {
                                                            <div class="small text-muted">@p.EventDate.Value.ToString("d")</div>
                                                        }
                                                        
                                                        <div class="mt-1">
                                                            @if (p.ClipId == null || p.Clip?.Event == null)
                                                            {
                                                                <span class="badge bg-dark text-secondary border border-secondary-subtle small" style="font-size: 0.65rem;">
                                                                    <i class="bi bi-archive me-1"></i> Archived Snapshot
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-dark text-info border border-info-subtle small" style="font-size: 0.65rem;">
                                                                    <i class="bi bi-link-45deg me-1"></i> Live Record
                                                                </span>
                                                            }
                                                        </div>
                                                    }
                                                    else if (p.Clip?.Event != null)
                                                    {
                                                        <div class="text-primary">@p.Clip.Event.Name</div>
                                                        <div class="small text-muted">@p.Clip.Event.Date.ToString("d")</div>
                                                    }
                                                    else
                                                    {
                                                        <div class="text-danger fst-italic small">Unknown Event</div>
                                                        <div class="text-muted extra-small" style="font-size: 0.6rem;">Missing Snapshot</div>
                                                    }
                                                </td>
                                                <td data-label="Price / Duration">
                                                    <div class="text-primary fw-bold">$@((p.PricePaidCents > 0 ? p.PricePaidCents : (p.Clip?.PriceCents ?? 0)) / 100.00)</div>
                                                    @{
                                                        var duration = p.Clip?.DurationSec ?? p.ClipDurationSec ?? 0;
                                                    }
                                                    <div class="small text-muted">@((int)duration) seconds</div>
                                                </td>
                                                <td data-label="Status">
                                                    @if (p.FulfillmentStatus == FulfillmentStatus.Fulfilled)
                                                    {
                                                        <span class="badge bg-success text-white rounded-pill px-3">
                                                            <i class="bi bi-check-circle-fill me-1"></i> Fulfilled
                                                        </span>
                                                        @if (p.FulfilledAt.HasValue)
                                                        {
                                                            <div style="font-size: 0.7rem; color: var(--text-muted);" class="mt-1 ms-1">
                                                                @p.FulfilledAt.Value.ToLocalTime().ToString("MM/dd h:mm tt")
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning bg-opacity-25 text-warning border border-warning-subtle rounded-pill px-3">
                                                            <i class="bi bi-clock me-1"></i> Pending
                                                        </span>
                                                    }
                                                </td>
                                                <td class="text-end pe-4" data-label="Action">
                                                    @if (p.FulfillmentStatus == FulfillmentStatus.Pending) 
                                                    {
                                                        <button class="btn btn-sm btn-primary shadow-sm" @onclick="() => OpenFulfillModal(p)">
                                                            <i class="bi bi-upload me-1"></i> Fulfill
                                                        </button>
                                                        @if (p.ClipId == null)
                                                        {
                                                            <div class="text-danger extra-small mt-1" style="font-size: 0.7rem;">Clip Deleted</div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <div class="d-flex flex-column align-items-end gap-2">
                                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenFulfillModal(p)">
                                                                <i class="bi bi-pencil me-1"></i> Update
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => RevertToPending(p)" title="Reset to Pending" style="font-size: 0.75rem;">
                                                                <i class="bi bi-arrow-counterclockwise me-1"></i> Undo
                                                            </button>
                                                        </div>
                                                        @if (p.ClipId == null)
                                                        {
                                                            <div class="text-muted extra-small mt-1" style="font-size: 0.7rem;">Clip Deleted</div>
                                                        }
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                             </div>
                        </div>
                    }
                }
        </div>
    </div>
</div>

@if (_showModal && _selectedPurchase != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.8);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">
                            @if (_currentOrderPurchases != null)
                            {
                                <i class="bi bi-cloud-upload me-2 text-primary"></i><span>Bulk Upload Clips: Order #@(_selectedPurchase?.OrderId ?? "N/A")</span>
                            }
                            else
                            {
                                <span>Fulfill Item: @(_selectedPurchase?.Clip?.Title ?? _selectedPurchase?.ClipTitle)</span>
                            }
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                    </div>
                    
                    @if (_currentOrderPurchases != null)
                    {
                        <div class="alert alert-info bg-info bg-opacity-10 border-0 text-info rounded-0 m-0 small py-2">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>System will automatically match files to items:</strong> 
                            @(string.Join(", ", _currentOrderPurchases.Select(p => p.ClipMasterFileName ?? p.Clip?.MasterFileName ?? p.ClipTitle ?? p.Clip?.Title ?? "Unknown")))
                        </div>
                    }
                    else
                    {
                        <div class="p-3 border-bottom border-secondary bg-black bg-opacity-25">
                            <label class="form-label text-muted small text-uppercase fw-bold m-0">Expected Filename</label>
                            <div class="p-2 bg-black rounded border border-secondary mt-1">
                                <code class="text-info">@(_selectedPurchase?.Clip?.MasterFileName ?? _selectedPurchase?.ClipMasterFileName ?? "No filename tracked")</code>
                            </div>
                            <label class="form-label text-muted small text-uppercase fw-bold m-0 mt-3">Expected Clip Title</label>
                            <div class="p-2 bg-black rounded border border-secondary mt-1">
                                <code class="text-info">@(_selectedPurchase?.Clip?.Title ?? _selectedPurchase?.ClipTitle ?? "No title tracked")</code>
                            </div>
                        </div>
                    }

                    <div class="modal-body p-0 bg-black">
                        <!-- Uppy Container -->
                        <div id="fulfillment-uppy-container" style="min-height: 400px; background: #111;"></div>
                        
                        @if (!string.IsNullOrEmpty(_uploadError))
                        {
                            <div class="alert alert-danger bg-danger bg-opacity-10 border-0 text-danger m-3">@_uploadError</div>
                        }
                    </div>
                    <div class="modal-footer border-secondary">
                        <button class="btn btn-outline-secondary" @onclick="CloseModal">Done / Close</button>
                    </div>
            </div>
        </div>
    </div>
}

@inject IJSRuntime JSRuntime
@inject IVideoService VideoService

@code {
    private List<Purchase>? _allPurchases;
    private List<Purchase>? _filteredPurchases;
    private string _currentFilter = "Pending";
    
    private bool _showModal = false;
    private Purchase? _selectedPurchase;

    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    
    // Upload State
    private string _uploadError = "";
    private DotNetObjectReference<Fulfillment>? _objRef;

    protected override async Task OnInitializedAsync()
    {
        // Ensure CORS is set up for browser uploads
        await StorageService.ConfigureCorsAsync();
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _allPurchases = await PurchaseRepository.ListAsync();
        ApplyFilter();
    }
    
    private void SetFilter(string filter)
    {
        _currentFilter = filter;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        if (_allPurchases == null) return;
        
        switch (_currentFilter)
        {
            case "Pending":
                _filteredPurchases = _allPurchases.Where(p => p.FulfillmentStatus == FulfillmentStatus.Pending).ToList();
                break;
            case "Fulfilled":
                _filteredPurchases = _allPurchases.Where(p => p.FulfillmentStatus == FulfillmentStatus.Fulfilled).ToList();
                break;
            default:
                _filteredPurchases = _allPurchases.ToList();
                break;
        }
    }

    private IJSObjectReference? _jsUppy;

    // Called by UI button
    private async Task OpenFulfillModal(Purchase p)
    {
        _selectedPurchase = p;
        _uploadError = "";
        _showModal = true;
        StateHasChanged();
        
        // Initialize Uppy after render
        await Task.Delay(100); 
        _objRef = DotNetObjectReference.Create(this);
        // We might want to store the JS reference to dispose later
        _jsUppy = await JSRuntime.InvokeAsync<IJSObjectReference>("fulfillmentUpload.initUppy", _objRef, "fulfillment-uppy-container");
    }

    private void CloseModal()
    {
        _showModal = false;
        _selectedPurchase = null;
        _currentOrderPurchases = null;
        _uploadToPurchaseMap.Clear();
    }

    private List<Purchase>? _currentOrderPurchases;
    private Dictionary<string, int> _uploadToPurchaseMap = new();

    private async Task OpenBulkUploadModal(List<Purchase> order)
    {
        _currentOrderPurchases = order;
        _selectedPurchase = order.FirstOrDefault(); // Just to open the modal
        _showModal = true;
        _uploadToPurchaseMap.Clear();
        _uploadError = "";
        StateHasChanged();

        // Initialize Uppy after render
        await Task.Delay(100);
        _objRef = DotNetObjectReference.Create(this);
        _jsUppy = await JSRuntime.InvokeAsync<IJSObjectReference>("fulfillmentUpload.initUppy", _objRef, "fulfillment-uppy-container");
    }

    [JSInvokable]
    public Task<string> GetR2UploadUrl(string fileName, string contentType)
    {
        Purchase? target = null;

        if (_currentOrderPurchases == null)
        {
            target = _selectedPurchase;
        }
        else 
        {
            // Bulk Match Mode

            // 1. Check if this exact file is already mapped (Idempotency)
            if (_uploadToPurchaseMap.TryGetValue(fileName, out var pId))
            {
                target = _currentOrderPurchases.FirstOrDefault(p => p.Id == pId);
            }

            if (target == null)
            {
                // 2. Try exact filename match (case-insensitive)
                target = _currentOrderPurchases.FirstOrDefault(p => 
                    p.FulfillmentStatus == FulfillmentStatus.Pending &&
                    !_uploadToPurchaseMap.Values.Contains(p.Id) &&
                    (string.Equals(p.ClipMasterFileName, fileName, StringComparison.OrdinalIgnoreCase) ||
                     string.Equals(p.Clip?.MasterFileName, fileName, StringComparison.OrdinalIgnoreCase) ||
                     (p.ClipMasterFileName != null && string.Equals(System.IO.Path.GetFileName(p.ClipMasterFileName.Replace("\\", "/")), fileName, StringComparison.OrdinalIgnoreCase))));
            }

            if (target == null)
            {
                // 3. Fallback: Super-Fuzzy match by Clip Title
                var normFileBase = SuperNormalize(System.IO.Path.GetFileNameWithoutExtension(fileName));
                
                target = _currentOrderPurchases.FirstOrDefault(p => 
                    p.FulfillmentStatus == FulfillmentStatus.Pending &&
                    !_uploadToPurchaseMap.Values.Contains(p.Id) &&
                    !string.IsNullOrEmpty(normFileBase) &&
                    (SuperNormalize(p.Clip?.Title).Contains(normFileBase) || 
                     SuperNormalize(p.ClipTitle).Contains(normFileBase) ||
                     normFileBase.Contains(SuperNormalize(p.Clip?.Title)) ||
                     normFileBase.Contains(SuperNormalize(p.ClipTitle))));
            }
        }

        if (target == null) 
        {
            return Task.FromResult("");
        }
        
        // Use OrderId for folder name instead of internal database Id
        // Use 8-char Order ID for folder name to match Email/UI
        var folderName = !string.IsNullOrEmpty(target.StripeSessionId) && target.StripeSessionId.Length >= 8
            ? target.StripeSessionId.Substring(target.StripeSessionId.Length - 8).ToUpper()
            : (!string.IsNullOrEmpty(target.OrderId) ? target.OrderId : target.Id.ToString());
            
        var key = $"{folderName}/{fileName}";
        _uploadToPurchaseMap[fileName] = target.Id;
        
        var url = StorageService.GetPresignedUploadUrl(key, contentType);
        return Task.FromResult(url);
    }

     [JSInvokable]
    public async Task OnUploadSuccess(string fileName)
    {
        if (_uploadToPurchaseMap.TryGetValue(fileName, out var purchaseId))
        {
             // Find the purchase in the current session list to avoid stale reference issues
             var purchase = _currentOrderPurchases?.FirstOrDefault(p => p.Id == purchaseId);
             if (purchase == null) 
             {
                 // Fallback to all purchases if not in current list (shouldn't happen in bulk mode)
                 purchase = _allPurchases?.FirstOrDefault(p => p.Id == purchaseId);
             }
             
             if (purchase == null) return;

             var key = "";
             var folderName = !string.IsNullOrEmpty(purchase.StripeSessionId) && purchase.StripeSessionId.Length >= 8
                 ? purchase.StripeSessionId.Substring(purchase.StripeSessionId.Length - 8).ToUpper()
                 : (!string.IsNullOrEmpty(purchase.OrderId) ? purchase.OrderId : purchase.Id.ToString());
             key = $"{folderName}/{fileName}";

             // 1. Update CLIP
             if (purchase.Clip != null)
             {
                 var trackedClip = await ClipRepository.GetByIdAsync(purchase.Clip.Id);
                 if (trackedClip != null)
                 {
                     trackedClip.MasterFileName = key;
                     await ClipRepository.UpdateAsync(trackedClip);
                     purchase.Clip.MasterFileName = key;
                 }
             }

             // 2. Update PURCHASE
             purchase.FulfillmentStatus = FulfillmentStatus.Fulfilled;
             purchase.FulfilledAt = DateTime.UtcNow;
             purchase.ClipMasterFileName = key;
             
             // Ensure download link is set
             var deliveryLink = $"{Navigation.BaseUri}delivery/{purchase.StripeSessionId}";
             purchase.HighResDownloadUrl = deliveryLink;

             await PurchaseRepository.UpdateAsync(purchase);
             
             // Log the action
             var authState = await AuthenticationStateTask;
             var user = authState.User;
             var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
             var userEmail = user.Identity?.Name;

             await AuditService.LogActionAsync(
                 userId, 
                 userEmail, 
                 "Fulfill Item (Bulk)", 
                 "Purchase", 
                 purchase.StripeSessionId, 
                 $"Item fulfilled via bulk upload: {fileName}");

             if (_currentOrderPurchases != null && _currentOrderPurchases.All(p => p.FulfillmentStatus == FulfillmentStatus.Fulfilled))
             {
                 await CompleteOrder(_currentOrderPurchases);
             }
             else 
             {
                 // Don't reload everything yet, just refresh UI state
                 StateHasChanged();
             }
        }
    }

    [JSInvokable]
    public void OnUploadError(string msg)
    {
        _uploadError = "Upload failed: " + msg;
        StateHasChanged();
    }
    
    // --- New Order Logic ---
    private async Task CompleteOrder(List<Purchase> order, bool isManualResend = false)
    {
        var firstItem = order.First();
        var customerEmail = firstItem.CustomerEmail;
        var deliveryLink = $"{Navigation.BaseUri}delivery/{firstItem.StripeSessionId}";
        
        var orderIdDisplay = !string.IsNullOrEmpty(firstItem.StripeSessionId) 
            ? (firstItem.StripeSessionId.Length > 8 ? firstItem.StripeSessionId.Substring(firstItem.StripeSessionId.Length - 8).ToUpper() : firstItem.StripeSessionId.ToUpper())
            : "N/A";

        foreach (var p in order)
        {
            if (p.FulfillmentStatus == FulfillmentStatus.Pending || string.IsNullOrEmpty(p.HighResDownloadUrl) || isManualResend)
            {
                // Auto-copy logic
                if (p.Clip != null && !string.IsNullOrEmpty(p.Clip.MasterFileName) && string.IsNullOrEmpty(p.ClipMasterFileName))
                {
                    var originalFileName = System.IO.Path.GetFileName(p.Clip.MasterFileName.Replace("\\", "/"));
                    // Use Order ID folder structure
                    var folderName = orderIdDisplay;
                    var newKey = $"{folderName}/{originalFileName}";

                    if (!await StorageService.FileExistsAsync(newKey))
                    {
                        await StorageService.CopyFileAsync(p.Clip.MasterFileName, newKey);
                    }
                    p.ClipMasterFileName = newKey; // Update to the order-specific path
                }

                p.FulfillmentStatus = FulfillmentStatus.Fulfilled;
                p.FulfilledAt ??= DateTime.UtcNow;
                // Save the dynamic link as the fallback
                p.HighResDownloadUrl = deliveryLink;
                await PurchaseRepository.UpdateAsync(p);
            }
        }

        // Log the action
        var authStateFinal = await AuthenticationStateTask;
        var userFinal = authStateFinal.User;
        var userIdFinal = userFinal.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        var userEmailFinal = userFinal.Identity?.Name;

        await AuditService.LogActionAsync(
            userIdFinal, 
            userEmailFinal, 
            isManualResend ? "Resend Fulfillment Email" : "Complete Order", 
            "Order", 
            firstItem.StripeSessionId ?? "Legacy", 
            $"Order completed and notification sent to {customerEmail}. Items: {order.Count}");

        // Send Email Notification
        if (!string.IsNullOrEmpty(customerEmail))
        {
            try 
            {
                var customerName = firstItem.CustomerName ?? "Customer";
                var htmlBody = await EmailTemplateService.GenerateFulfillmentEmailHtmlAsync(orderIdDisplay, order, customerName);

                await EmailService.SendEmailAsync(customerEmail, $"Your Video Order is Ready! (#{orderIdDisplay})", htmlBody);
            }
            catch (Exception)
            {
                // Silent catch or use proper logging if available
            }
        }
        
        // Switch to "Fulfilled" tab to show the result
        if (!isManualResend)
        {
            _currentFilter = "Fulfilled";
        }
        await LoadDataAsync();
    }

    private async Task RevertToPending(Purchase p)
    {
        if (p.FulfillmentStatus != FulfillmentStatus.Fulfilled) return;

        // Reset status
        p.FulfillmentStatus = FulfillmentStatus.Pending;
        p.FulfilledAt = null;
        p.HighResDownloadUrl = null;
        
        // Clear the order-specific file link (we don't delete the file, just the reference to allow re-copy if needed)
        p.ClipMasterFileName = null;
        
        await PurchaseRepository.UpdateAsync(p);
        
        // Log
        var authState = await AuthenticationStateTask;
        var user = authState.User;
        var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        var userEmail = user.Identity?.Name;

        await AuditService.LogActionAsync(
            userId, 
            userEmail, 
            "Revert Fulfillment", 
            "Purchase", 
            p.StripeSessionId, 
            $"Item reverted to pending: {p.Clip?.Title}");

        await LoadDataAsync();
    }

    private string SuperNormalize(string? input)
    {
        if (string.IsNullOrEmpty(input)) return "";
        return new string(input.ToLower().Where(c => char.IsLetterOrDigit(c)).ToArray());
    }

    public async ValueTask DisposeAsync()
    {
        _objRef?.Dispose();
        if (_jsUppy != null)
        {
            await _jsUppy.InvokeVoidAsync("dispose");
            await _jsUppy.DisposeAsync();
        }
    }
}
